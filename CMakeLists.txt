cmake_minimum_required(VERSION 3.10)
project(ccid VERSION 1.7.0 LANGUAGES C)

# QNX-specific build configuration
# This CMakeLists.txt is ONLY for QNX 8.0 cross-compilation
# Standard builds should use Meson (meson setup builddir && meson compile -C builddir)

# Ensure QNX platform is being used
if(NOT CMAKE_SYSTEM_NAME STREQUAL "QNX")
    message(WARNING "This CMakeLists.txt is optimized for QNX 8.0 cross-compilation.")
    message(WARNING "For standard builds, please use Meson instead:")
    message(WARNING "  meson setup builddir && meson compile -C builddir")
endif()

# Set C standard
set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED ON)

# Compiler flags
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fvisibility=hidden -Wall")

# Note: config.h is generated by Meson (primary build system)
# For CMake QNX builds, always generate QNX-specific config.h
# (don't use Meson-generated one since it's for Linux)

message(STATUS "Generating QNX-specific config.h")
file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/config.h" "
#ifndef __CONFIG_H__
#define __CONFIG_H__

#define VERSION \"1.7.0\"
#define BUNDLE \"ifd-ccid.bundle\"
#define PCSCLITE_HP_DROPDIR \"/usr/lib/pcsc/drivers\"
#undef ENABLE_ZLP
#undef NO_LOG
#undef USE_OS_LOG
#undef USE_COMPOSITE_AS_MULTISLOT
#undef HAVE_STRLCPY
#undef HAVE_STRLCAT
#define HAVE_SECURE_GETENV 1
#define HAVE_PTHREAD_CONDATTR_SETCLOCK 1
#define HAVE_QNX 1

#endif /* __CONFIG_H__ */
")

# Include directories
include_directories(
    "${CMAKE_CURRENT_SOURCE_DIR}/src"
    "${CMAKE_CURRENT_BINARY_DIR}"
)

# Find required packages
find_package(PkgConfig)
if(PKGCONFIG_FOUND)
    # For QNX cross-compilation, skip system libraries that aren't in QNX SDK
    if(NOT CMAKE_SYSTEM_NAME STREQUAL "QNX")
        pkg_check_modules(PCSCLITE libpcsclite QUIET)
        pkg_check_modules(ZLIB zlib QUIET)
    else()
        # QNX: Only look for libraries in QNX target directory
        message(STATUS "Cross-compiling for QNX - skipping host system library checks")
    endif()
else()
    message(WARNING "PkgConfig not found - some libraries may not be available for QNX")
endif()
find_package(Threads REQUIRED)

# For QNX, we don't need external libusb since we use the shim
# libusb_dep is replaced by libusb_shim_qnx.c

if(CMAKE_SYSTEM_NAME STREQUAL "QNX")
    # For QNX, use pcsclite headers from /home/harynath922/PCSC/src/PCSC
    include_directories(/home/harynath922/PCSC/src/PCSC)
    # Also include QNX system headers (devctl.h, etc.)
    include_directories(${QNX_TARGET}/usr/include)
    # Include QNX USB/device headers (libusbdi)
    include_directories(${QNX_TARGET}/usr/include/devs/dev/usb)
    message(STATUS "QNX platform detected - using pcsclite headers from /home/harynath922/PCSC/src/PCSC")
    message(STATUS "QNX system headers from ${QNX_TARGET}/usr/include")
    message(STATUS "QNX USB headers from ${QNX_TARGET}/usr/include/devs/dev/usb")
endif()

if(PCSCLITE_INCLUDE_DIRS)
    include_directories(${PCSCLITE_INCLUDE_DIRS})
endif()
if(ZLIB_INCLUDE_DIRS)
    include_directories(${ZLIB_INCLUDE_DIRS})
endif()

# Flex lexer generation
find_program(FLEX_EXECUTABLE NAMES flex)
if(FLEX_EXECUTABLE)
    add_custom_command(
        OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/tokenparser.c"
        COMMAND ${FLEX_EXECUTABLE} -o "${CMAKE_CURRENT_BINARY_DIR}/tokenparser.c"
                --prefix=tokenparser "${CMAKE_CURRENT_SOURCE_DIR}/src/tokenparser.l"
        DEPENDS "${CMAKE_CURRENT_SOURCE_DIR}/src/tokenparser.l"
        COMMENT "Generating tokenparser.c from tokenparser.l"
    )
else()
    message(FATAL_ERROR "flex not found. Please install flex.")
endif()

# Core libccid source files
set(LIBCCID_SOURCES
    src/ccid.c
    src/ccid_usb.c
    src/commands.c
    src/ifdhandler.c
    src/simclist.c
    src/strlcpy.c
    src/sys_unix.c
    src/utils.c
    src/openct/buffer.c
    src/openct/checksum.c
    src/openct/proto-t1.c
    src/towitoko/atr.c
    src/towitoko/pps.c
    "${CMAKE_CURRENT_BINARY_DIR}/tokenparser.c"
)

# QNX-specific: add libusb shim implementation
list(APPEND LIBCCID_SOURCES src/libusb_shim_qnx.c)

# Create libccid library
add_library(ccid SHARED ${LIBCCID_SOURCES})

# Link libraries
target_link_libraries(ccid PRIVATE
    Threads::Threads
)
# Optional: link system libraries if available (only on non-QNX or if found)
if(CMAKE_SYSTEM_NAME STREQUAL "QNX")
    # For QNX cross-compile, link libusbdi for USB device enumeration
    target_link_libraries(ccid PRIVATE usbdi)
    
    # Also link other available libraries
    if(PCSCLITE_FOUND AND PCSCLITE_LIBRARIES)
        target_link_libraries(ccid PRIVATE ${PCSCLITE_LIBRARIES})
    endif()
    if(ZLIB_FOUND AND ZLIB_LIBRARIES)
        target_link_libraries(ccid PRIVATE ${ZLIB_LIBRARIES})
    endif()
else()
    # For native builds, link available libraries
    if(PCSCLITE_LIBRARIES)
        target_link_libraries(ccid PRIVATE ${PCSCLITE_LIBRARIES})
    endif()
    if(ZLIB_LIBRARIES)
        target_link_libraries(ccid PRIVATE ${ZLIB_LIBRARIES})
    endif()
endif()
# Try to link dl, but don't fail if not found
if(NOT CMAKE_SYSTEM_NAME STREQUAL "QNX")
    target_link_libraries(ccid PRIVATE dl)
endif()

# Compiler definitions
target_compile_definitions(ccid PRIVATE
    -DSIMCLIST_NO_DUMPRESTORE
    -DHAVE_QNX
    -D__QNX__
)

# Installation
# For QNX, install to a standard location
# Actual installation directory can be customized with -DCMAKE_INSTALL_PREFIX
install(TARGETS ccid
    LIBRARY DESTINATION lib
    COMPONENT libraries
)

# parse utility (optional, for QNX testing)
# Enabled for QNX platform - provides CCID descriptor parsing
set(PARSE_SOURCES
    src/parse.c
    src/debug.c
    src/ccid_usb.c
    src/sys_unix.c
    src/strlcpy.c
    src/simclist.c
    "${CMAKE_CURRENT_BINARY_DIR}/tokenparser.c"
)

# For QNX, add libusb shim implementation
if(CMAKE_SYSTEM_NAME STREQUAL "QNX")
    list(APPEND PARSE_SOURCES src/libusb_shim_qnx.c)
endif()

add_executable(parse ${PARSE_SOURCES})

target_link_libraries(parse PRIVATE
    Threads::Threads
)
# Optional: link system libraries if available
if(CMAKE_SYSTEM_NAME STREQUAL "QNX")
    # For QNX cross-compile, link libusbdi for USB device enumeration
    target_link_libraries(parse PRIVATE usbdi)
    
    # Also link other available libraries
    if(PCSCLITE_FOUND AND PCSCLITE_LIBRARIES)
        target_link_libraries(parse PRIVATE ${PCSCLITE_LIBRARIES})
    endif()
    if(ZLIB_FOUND AND ZLIB_LIBRARIES)
        target_link_libraries(parse PRIVATE ${ZLIB_LIBRARIES})
    endif()
else()
    # For native builds, link available libraries
    if(PCSCLITE_LIBRARIES)
        target_link_libraries(parse PRIVATE ${PCSCLITE_LIBRARIES})
    endif()
    if(ZLIB_LIBRARIES)
        target_link_libraries(parse PRIVATE ${ZLIB_LIBRARIES})
    endif()
    target_link_libraries(parse PRIVATE dl)
endif()

target_compile_definitions(parse PRIVATE
    DSIMCLIST_NO_DUMPRESTORE
)

if(CMAKE_SYSTEM_NAME STREQUAL "QNX")
    target_compile_definitions(parse PRIVATE
        DHAVE_QNX
        D__QNX__
    )
endif()

install(TARGETS parse
    RUNTIME DESTINATION bin
    COMPONENT utilities
)

# Summary
message(STATUS "")
message(STATUS "=== libccid QNX 8.0 Build Configuration ===")
message(STATUS "System: ${CMAKE_SYSTEM_NAME}")
message(STATUS "Compiler: ${CMAKE_C_COMPILER}")
message(STATUS "Version: ${PROJECT_VERSION}")
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Install prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "")
message(STATUS "Libraries: ccid (shared)")
# message(STATUS "Utilities: parse")
message(STATUS "")
message(STATUS "To build: cmake --build . [--config Release]")
message(STATUS "To install: cmake --install . [--config Release]")
message(STATUS "")
